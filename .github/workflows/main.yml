name: üîÅ Full Django CI with AI, Backup & Playwright

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 17 * * 1-5'
  workflow_dispatch:

jobs:
  # –ó–ê–í–î–ê–ù–ù–Ø –î–õ–Ø –ü–ï–†–ï–í–Ü–†–ö–ò –ö–û–î–£ –¢–ê –ó–ê–ü–£–°–ö–£ –¢–ï–°–¢–Ü–í
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      - name:  checkout
        uses: actions/checkout@v4

      - name: üîß –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: üîê –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Å–µ–∫—Ä–µ—Ç–∏ –¥–ª—è Django
        if: env.DB_HOST != '' # –¶–µ–π –∫—Ä–æ–∫ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è —Ç–µ—Å—Ç—ñ–≤, –∞–ª–µ –∫–æ—Ä–∏—Å–Ω–∏–π –¥–ª—è check
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
        shell: bash
        run: |
          echo "::add-mask::${{ secrets.DB_NAME }}"
          echo "::add-mask::${{ secrets.DB_USER }}"
          echo "::add-mask::${{ secrets.DB_PASSWORD }}"
          echo "::add-mask::${{ secrets.DB_HOST }}"
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
          echo "DATABASE_URL=postgres://$DB_USER:$DB_PASSWORD@$DB_HOST:5432/$DB_NAME" >> $GITHUB_ENV

      - name: üìå –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ PYTHONPATH
        run: echo "PYTHONPATH=." >> $GITHUB_ENV

      - name: üìÜ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ‚öôÔ∏è Django —Å–∏—Å—Ç–µ–º–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        run: |
          python manage.py check
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput

      - name: ü•™ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ Python —Ç–µ—Å—Ç–∏
        run: python manage.py test

  # –ó–ê–í–î–ê–ù–ù–Ø –î–õ–Ø UI –¢–ï–°–¢–Ü–í (–ë–ï–ó –ó–ú–Ü–ù)
  ui_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: ü•§ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Node + Playwright
        uses: actions/setup-node@v3
        with:
          node-version: 20
      - name: üìÜ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Playwright
        run: |
          npm ci
          npx playwright install --with-deps
      - name: ü•™ UI —Ç–µ—Å—Ç–∏ Playwright
        run: npx playwright test

  # –ó–ê–í–î–ê–ù–ù–Ø –î–õ–Ø –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–Ü–Æ–í–ê–ù–ù–Ø (–ë–ï–ó –ó–ú–Ü–ù)
  db_backup:
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - name: ü•ê –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —ñ–º'—è —Ñ–∞–π–ª—É
        id: vars
        run: echo "file=backup-$(date +'%Y-%m-%d').sql" >> $GITHUB_OUTPUT
      - name: üîê –°–µ–∫—Ä–µ—Ç–∏ + ::add-mask
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
        shell: bash
        run: |
          echo "::add-mask::${{ secrets.DB_NAME }}"
          echo "::add-mask::${{ secrets.DB_USER }}"
          echo "::add-mask::${{ secrets.DB_PASSWORD }}"
          echo "::add-mask::${{ secrets.DB_HOST }}"
          echo "::add-mask::${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}"
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV
      - name: ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç—ñ–≤
        shell: bash
        run: |
          for var in DB_NAME DB_USER DB_PASSWORD DB_HOST; do
            echo "$var=***"
            if [ -z "${!var}" ]; then
              echo "‚õîÔ∏è SECRET $var is missing!"
              exit 1
            fi
          done
      - name: üóìÔ∏è PostgreSQL Backup (Supabase)
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          export PGPASSWORD=$DB_PASSWORD
          pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME > ${{ steps.vars.outputs.file }}
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_NAME: ${{ secrets.DB_NAME }}
      - name: üóìÔ∏è –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ cms-sa.json
        run: echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}' > cms-sa.json
      - name: ‚òÅÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É Google Drive
        run: |
          pip install --upgrade google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib
          python upload_to_drive.py ${{ steps.vars.outputs.file }}
        env:
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

  # –ó–ê–í–î–ê–ù–ù–Ø –î–õ–Ø AI –†–ï–í'–Æ (–ë–ï–ó –ó–ú–Ü–ù)
  ai_review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: ü§Æ –ó—á–∏—Ç–∞—Ç–∏ –∑–º—ñ–Ω–∏ PR
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > patch.diff
      - name: ü§Æ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–∞ AI —Ä–µ–≤'—é (ChatGPT)
        shell: bash
        run: |
          echo "::add-mask::${{ secrets.OPENAI_API_KEY }}"
          # (–í–∞—à curl –∑–∞–ø–∏—Ç –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
      - name: üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä —É PR (GitHub CLI)
        if: success()
        run: gh pr comment ${{ github.event.pull_request.number }} -F ai_review.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
