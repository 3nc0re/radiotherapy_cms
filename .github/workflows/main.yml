# .github/workflows/main.yml

name: ðŸ” Full Django CI with AI, Backup & Playwright

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 17 * * 1-5'  # Ð©Ð¾Ð´ÐµÐ½Ð½Ð¸Ð¹ Ð±ÐµÐºÐ°Ð¿ Ñƒ Ð±ÑƒÐ´Ð½Ñ–
  workflow_dispatch:

jobs:
  build:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10]

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ðŸ“¦ Python Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: âš™ï¸ Django Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸
        run: |
          python manage.py check
          python manage.py migrate --noinput

      - name: ðŸ§ª Python Ñ‚ÐµÑÑ‚Ð¸
        run: |
          python manage.py test

      - name: â± ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ð·Ð°Ð»Ð¸ÑˆÐ¾Ðº Ñ…Ð²Ð¸Ð»Ð¸Ð½ GitHub Actions
        run: |
          gh api /rate_limit | jq '.rate.remaining as $r | "â³ Ð—Ð°Ð»Ð¸ÑˆÐ¸Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿Ð¸Ñ‚Ñ–Ð²: \($r)"'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ui_tests:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ§© Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Node + Playwright
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: ðŸ“¦ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Playwright
        run: |
          npm ci
          npx playwright install --with-deps

      - name: ðŸ§ª UI Ñ‚ÐµÑÑ‚Ð¸ Playwright
        run: npx playwright test

  db_backup:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ’¾ PostgreSQL Backup (Supabase)
        run: |
          pg_dump -h ${{ secrets.DB_HOST }} -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} > backup.sql
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: â˜ï¸ Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ ÑÐº GitHub Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: backup.sql

      - name: â˜ï¸ Ð—Ð°Ð»Ð¸Ð²ÐºÐ° Ð² Google Drive
        uses: 'marketplace-actions/gdrive-upload@v1'
        with:
          filename: backup.sql
          folderId: ${{ secrets.GDRIVE_FOLDER_ID }}
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}

  ai_review:
    if: github.event_name == 'pull_request' && github.event.pull_request.user.login != 'dependabot'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¤– Ð—Ñ‡Ð¸Ñ‚Ð°Ñ‚Ð¸ Ð·Ð¼Ñ–Ð½Ð¸ PR
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > patch.diff

      - name: ðŸ§  Ð’Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ð¸ Ð½Ð° AI Ñ€ÐµÐ²Ê¼ÑŽ (ChatGPT)
        run: |
          curl https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {"role": "system", "content": "You are a code reviewer."},
                {"role": "user", "content": "Review the following diff:\n$(cat patch.diff)"}
              ]
            }' > ai_review.txt

      - name: ðŸ’¬ ÐšÐ¾Ð¼ÐµÐ½Ñ‚Ð°Ñ€ Ñƒ PR (Ð¾Ð¿Ñ†Ñ–Ð¹Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· gh)
        if: success()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -F ai_review.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
