name: ðŸ” Full Django CI with AI, Backup & Playwright

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 17 * * 1-5'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”§ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ðŸ” Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð¸ Ñ‚Ð° ::add-mask::
        run: |
          echo "::add-mask::${{ secrets.DB_NAME }}"
          echo "::add-mask::${{ secrets.DB_USER }}"
          echo "::add-mask::${{ secrets.DB_PASSWORD }}"
          echo "::add-mask::${{ secrets.DB_HOST }}"
          echo "::add-mask::postgres://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:5432/${{ secrets.DB_NAME }}"
          echo "::add-mask::${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}"
          echo "::add-mask::${{ secrets.OPENAI_API_KEY }}"
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV

      - name: âœ… ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ñ–Ð²
        run: |
          for var in DB_NAME DB_USER DB_PASSWORD DB_HOST; do
            if [ -z "${!var}" ]; then
              echo "â›”ï¸ SECRET $var is missing!"
              exit 1
            fi
          done

      - name: ðŸ“† Python Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: âš™ï¸ Django Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸
        run: |
          export DATABASE_URL=postgres://$DB_USER:$DB_PASSWORD@$DB_HOST:5432/$DB_NAME
          echo "::add-mask::$DATABASE_URL"
          python manage.py check
          python manage.py migrate --noinput

      - name: ðŸ¥ª Python Ñ‚ÐµÑÑ‚Ð¸
        run: python manage.py test

  ui_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¥¤ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Node + Playwright
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: ðŸ“† Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Playwright
        run: |
          npm ci
          npx playwright install --with-deps

      - name: ðŸ¥ª UI Ñ‚ÐµÑÑ‚Ð¸ Playwright
        run: npx playwright test

  db_backup:
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¥ Ð—Ð³ÐµÐ½ÐµÑ€ÑƒÐ²Ð°Ñ‚Ð¸ Ñ–Ð¼'Ñ Ñ„Ð°Ð¹Ð»Ñƒ
        id: vars
        run: echo "file=backup-$(date +'%Y-%m-%d').sql" >> $GITHUB_OUTPUT

      - name: ðŸ” Ð¡ÐµÐºÑ€ÐµÑ‚Ð¸ + ::add-mask::
        run: |
          echo "::add-mask::${{ secrets.DB_NAME }}"
          echo "::add-mask::${{ secrets.DB_USER }}"
          echo "::add-mask::${{ secrets.DB_PASSWORD }}"
          echo "::add-mask::${{ secrets.DB_HOST }}"
          echo "::add-mask::${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}"
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> $GITHUB_ENV

      - name: âœ… ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ñ–Ð²
        run: |
          for var in DB_NAME DB_USER DB_PASSWORD DB_HOST; do
            if [ -z "${!var}" ]; then
              echo "â›”ï¸ SECRET $var is missing!"
              exit 1
            fi
          done

      - name: ðŸ—“ï¸ PostgreSQL Backup (Supabase)
        run: |
          export PGPASSWORD=$DB_PASSWORD
          pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME > ${{ steps.vars.outputs.file }}

      - name: ðŸ—“ï¸ Ð’Ñ–Ð´Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ cms-sa.json
        run: echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}' > cms-sa.json

      - name: â˜ï¸ Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ñƒ Google Drive
        run: |
          pip install --upgrade google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib
          python upload_to_drive.py ${{ steps.vars.outputs.file }}
        env:
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

  ai_review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ¤® Ð—Ñ‡Ð¸Ñ‚Ð°Ñ‚Ð¸ Ð·Ð¼Ñ–Ð½Ð¸ PR
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > patch.diff

      - name: ðŸ¤® Ð’Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ð¸ Ð½Ð° AI Ñ€ÐµÐ²'ÑŽ (ChatGPT)
        run: |
          echo "::add-mask::${{ secrets.OPENAI_API_KEY }}"
          curl https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {"role": "system", "content": "You are a code reviewer."},
                {"role": "user", "content": "Review the following diff:\n$(cat patch.diff)"}
              ]
            }' > ai_review.txt

      - name: ðŸ’¬ ÐšÐ¾Ð¼ÐµÐ½Ñ‚Ð°Ñ€ Ñƒ PR (GitHub CLI)
        if: success()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -F ai_review.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
