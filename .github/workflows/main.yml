# .github/workflows/main.yml

name: üîÅ Full Django CI with AI, Backup & Playwright

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '0 17 * * 1-5'  # –©–æ–¥–µ–Ω–Ω–∏–π –±–µ–∫–∞–ø –æ 17:00 –ø–æ –±—É–¥–Ω—è—Ö
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      - uses: actions/checkout@v4

      - name: üîß –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: üì¶ Python –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ‚öôÔ∏è Django –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        run: |
          python manage.py check
          python manage.py migrate --noinput

      - name: üß™ Python —Ç–µ—Å—Ç–∏
        run: |
          python manage.py test

  ui_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: ü•§ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Node + Playwright
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: üì¶ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Playwright
        run: |
          npm ci
          npx playwright install --with-deps

      - name: üß™ UI —Ç–µ—Å—Ç–∏ Playwright
        run: npx playwright test

  db_backup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: üìÜ PostgreSQL Backup (Supabase)
        run: |
          pg_dump -h ${{ secrets.DB_HOST }} -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} > backup.sql
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: üìÖ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ cms-sa.json
        run: echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}' > cms-sa.json

      - name: ‚òÅÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É Google Drive
        run: |
          pip install --upgrade google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib
          python upload_to_drive.py
        env:
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}

  ai_review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: üßê –ó—á–∏—Ç–∞—Ç–∏ –∑–º—ñ–Ω–∏ PR
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > patch.diff

      - name: üßê –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–∞ AI —Ä–µ–≤‚Äô—é (ChatGPT)
        run: |
          curl https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {"role": "system", "content": "You are a code reviewer."},
                {"role": "user", "content": "Review the following diff:\n$(cat patch.diff)"}
              ]
            }' > ai_review.txt

      - name: üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä —É PR (GitHub CLI)
        if: success()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} -F ai_review.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# –°–µ–∫—Ä–µ—Ç–∏ —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ:
# - DB_HOST, DB_USER, DB_PASSWORD, DB_NAME
# - GDRIVE_FOLDER_ID: —ñ–¥ –∫–æ—Ä–µ–Ω–µ–≤–æ—ó —Ç–µ–∫–∏ –≤ Google Drive
# - GDRIVE_SERVICE_ACCOUNT_JSON: –æ–¥–Ω–æ—Ä—è–¥–∫–æ–≤–∏–π JSON (–∑ cms-sa.json)
# - OPENAI_API_KEY: –¥–ª—è ChatGPT —Ä–µ–≤‚Äô—é
# - GH_TOKEN: –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —É Pull Request
