{% extends 'base.html' %}
{% block content %}
<div class="patients-container">
    <a href="{% url 'dashboard' %}" class="back-link"><i class="fas fa-arrow-left"></i> Назад до дашборду</a>
    
    <h1>{% if is_archive %}Архів пацієнтів{% else %}Пацієнти{% endif %}</h1>

    <div class="filter-tabs">
        <a href="{% url 'patient_list' %}" class="tab-link {% if not filter_type and not is_archive %}active{% endif %}">Всі активні</a>
        <a href="{% url 'patient_list_filtered' 'ct-simulation' %}" class="tab-link {% if filter_type == 'ct-simulation' %}active{% endif %}">КТ-симуляція</a>
        <a href="{% url 'patient_list_filtered' 'treatment-start' %}" class="tab-link {% if filter_type == 'treatment-start' %}active{% endif %}">Підготовка до лікування</a>
        <a href="{% url 'patient_list_filtered' 'in-treatment' %}" class="tab-link {% if filter_type == 'in-treatment' %}active{% endif %}">Лікування</a>
        <a href="{% url 'patient_list_filtered' 'discharge-prep' %}" class="tab-link {% if filter_type == 'discharge-prep' %}active{% endif %}">Підготовка до виписки</a>
        <a href="{% url 'patient_archive' %}" class="tab-link {% if is_archive %}active{% endif %}">Архів</a>
    </div>

    <div class="card">
        <table class="patients-table">
            <thead>
                <tr>
                    <th>
                        <a href="{% if filter_type %}{% url 'patient_list_filtered' filter_type %}{% else %}{% url 'patient_list' %}{% endif %}?sort=full_name&order={% if current_sort == 'full_name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            ПІБ
                            {% if current_sort == 'full_name' %}
                                <i class="fas fa-sort-{% if current_order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% else %}
                                <i class="fas fa-sort"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="{% if filter_type %}{% url 'patient_list_filtered' filter_type %}{% else %}{% url 'patient_list' %}{% endif %}?sort=ct_simulation_date&order={% if current_sort == 'ct_simulation_date' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            Дата КТ-симуляції
                            {% if current_sort == 'ct_simulation_date' %}
                                <i class="fas fa-sort-{% if current_order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% else %}
                                <i class="fas fa-sort"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="{% if filter_type %}{% url 'patient_list_filtered' filter_type %}{% else %}{% url 'patient_list' %}{% endif %}?sort=treatment_start_date&order={% if current_sort == 'treatment_start_date' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            Дата початку лікування
                            {% if current_sort == 'treatment_start_date' %}
                                <i class="fas fa-sort-{% if current_order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% else %}
                                <i class="fas fa-sort"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="{% if filter_type %}{% url 'patient_list_filtered' filter_type %}{% else %}{% url 'patient_list' %}{% endif %}?sort=discharge_date&order={% if current_sort == 'discharge_date' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            Дата виписки
                            {% if current_sort == 'discharge_date' %}
                                <i class="fas fa-sort-{% if current_order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% else %}
                                <i class="fas fa-sort"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>Поточний етап</th>
                    <th>
                        <a href="{% if filter_type %}{% url 'patient_list_filtered' filter_type %}{% else %}{% url 'patient_list' %}{% endif %}?sort=medical_incapacity_end&order={% if current_sort == 'medical_incapacity_end' and current_order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            МВТН до
                            {% if current_sort == 'medical_incapacity_end' %}
                                <i class="fas fa-sort-{% if current_order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% else %}
                                <i class="fas fa-sort"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>Деталі</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr>
                    <td>
                        <a href="{% url 'patient_detail' patient.pk %}" class="patient-name-link">{{ patient.full_name }}</a>
                    </td>
                    <td>{{ patient.ct_simulation_date|date:"d.m.Y"|default:"—" }}</td>
                    <td>{{ patient.treatment_start_date|date:"d.m.Y"|default:"—" }}</td>
                    <td>{{ patient.discharge_date|date:"d.m.Y"|default:"—" }}</td>
                    <td>{{ patient.display_stage }}</td>
                    <td>
                        {% with latest_incapacity=patient.get_latest_medical_incapacity %}
                            {{ latest_incapacity.end_date|date:"d.m.Y"|default:"—" }}
                        {% endwith %}
                    </td>
                    <td>
                        <a href="{% url 'patient_detail' patient.pk %}" class="btn-details">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Пацієнтів немає</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.patients-container {
    position: relative;
    padding-top: 20px;
}
.back-link {
    position: absolute;
    left: 0;
    top: 0;
    text-decoration: none;
    color: var(--primary-color);
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.patients-container h1 {
    text-align: center;
    margin-bottom: 30px;
}
.filter-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}
.tab-link {
    padding: 10px 20px;
    text-decoration: none;
    color: var(--text-light-color);
    font-weight: 500;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}
.tab-link:hover {
    color: var(--primary-color);
}
.tab-link.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}
.patients-table {
    width: 100%;
    border-collapse: collapse;
}
.patients-table th, .patients-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.patients-table th {
    font-weight: 600;
    color: var(--text-light-color);
}
.sort-link {
    text-decoration: none;
    color: inherit;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: color 0.3s ease;
}
.sort-link:hover {
    color: var(--primary-color);
}
.sort-link i {
    font-size: 0.8em;
    opacity: 0.7;
}
.patients-table tbody tr:hover {
    background-color: #f8f9fa;
}
.btn-details {
    text-decoration: none;
    color: var(--primary-color);
    font-size: 1.2rem;
}
.patient-name-link {
    text-decoration: none;
    color: var(--text-color);
    font-weight: 500;
    transition: color 0.2s ease;
}
.patient-name-link:hover {
    color: var(--primary-color);
    text-decoration: underline;
}
.text-center {
    text-align: center;
}
</style>
{% endblock %} 