{% extends 'base.html' %}
{% block content %}

<a href="{% url 'patient_list' %}" class="back-link">← До списку пацієнтів</a>
<div class="patient-header">
    <h1>{{ patient.full_name }}</h1>
    <div class="header-actions">
        <a href="{% url 'patient_update' patient.pk %}" class="btn btn-primary"><i class="fas fa-edit"></i> Редагувати</a>
        <a href="{% url 'patient_delete' patient.pk %}" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Видалити</a>
    </div>
</div>

<div class="details-grid">
    <div class="card patient-info">
        <h3><i class="fas fa-user-circle"></i> Загальна інформація</h3>
        <p><strong>Діагноз:</strong> {{ patient.diagnosis|default:"—" }}</p>
        <p><strong>Поточний етап:</strong> <span class="badge">{{ patient.display_stage|default:"—" }}</span></p>
        <p><strong>Дата КТ:</strong> {{ patient.ct_simulation_date|date:"d.m.Y"|default:"—" }}</p>
        <p><strong>Дата початку лікування:</strong> {{ patient.treatment_start_date|date:"d.m.Y"|default:"—" }}</p>
        <p><strong>Дата виписки:</strong> {{ patient.discharge_date|date:"d.m.Y"|default:"—" }}</p>
        <p><strong>Дата останнього аналізу крові:</strong> {{ patient.last_blood_test_date|date:"d.m.Y"|default:"—" }}</p>
        <p><strong>Примітки:</strong> {{ patient.notes|default:"—" }}</p>
    </div>

    <div class="card copy-card full-width">
        <h3><i class="fas fa-clipboard"></i> Коротка довідка</h3>
        <textarea id="summary-text" readonly class="copy-text">{{ patient.summary_text }}</textarea>
        <button id="copy-summary" class="btn btn-secondary">Копіювати</button>
    </div>

    <div class="card notifications-card">
        <h3><i class="fas fa-bell"></i> Сповіщення</h3>
        {% if notifications %}
            <ul>
                {% for notification in notifications %}
                    <li>
                        {% if notification.type == 'blood_test' %}
                            <i class="fas fa-tint" style="color: #dc3545;"></i>
                            Потрібно здати аналіз крові (термін до {{ notification.due_date|date:"d.m.Y" }}).
                        {% elif notification.type == 'incapacity' %}
                            <i class="fas fa-file-medical-alt" style="color: #ffc107;"></i>
                            Закінчується МВТН {{ notification.incapacity_end_date|date:"d.m.Y" }}.
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Сповіщень немає</p>
        {% endif %}
    </div>
    
    <div class="card treatment-info">
        <h3><i class="fas fa-radiation"></i> Інформація про лікування</h3>
        <p><strong>СОД (Гр):</strong> {{ patient.received_dose|default:"—" }}</p>
        <p><strong>РОД (Гр):</strong> {{ patient.dose_per_fraction|default:"—" }}</p>
        <p><strong>Загальна кількість фракцій:</strong> {{ patient.total_fractions|default:"—" }}</p>
        <p><strong>Поточна фракція:</strong> {{ patient.current_fraction|default:"0" }}</p>
    </div>

    <div class="card full-width">
        <h3><i class="fas fa-history"></i> Історія фракцій</h3>
        <a href="{% url 'generate_fractions' patient.pk %}" class="btn btn-secondary">Згенерувати фракції</a>
        {% if fractions %}
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Підтверджено лікарем</th>
                        <th>Підтверджено медсестрою</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fraction in fractions %}
                    <tr>
                        <td>{{ fraction.date|date:"d.m.Y" }}</td>
                        <td>{{ fraction.doctor_confirmation|yesno:"Так,Ні" }}</td>
                        <td>{{ fraction.nurse_confirmation|yesno:"Так,Ні" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Історія фракцій порожня.</p>
        {% endif %}
    </div>
    
    <div class="card full-width">
        <h3><i class="fas fa-file-medical"></i> Лікарняні листи</h3>
        <a href="{% url 'medical_incapacity_create' patient.pk %}" class="btn btn-secondary">Додати лікарняний</a>
        {% if incapacities %}
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Дата початку</th>
                        <th>Дата закінчення</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incapacity in incapacities %}
                    <tr>
                        <td>{{ incapacity.start_date|date:"d.m.Y" }}</td>
                        <td>{{ incapacity.end_date|date:"d.m.Y" }}</td>
                        <td>
                            <a href="{% url 'medical_incapacity_delete' incapacity.pk %}" class="btn-danger-small">Видалити</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Лікарняних листів немає.</p>
        {% endif %}
    </div>
</div>

<style>
.back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: var(--primary-color);
    text-decoration: none;
}
.patient-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.header-actions {
    display: flex;
    gap: 10px;
}
.btn {
    text-decoration: none;
    padding: 10px 15px;
    border-radius: 5px;
    color: white;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-primary { background-color: var(--primary-color); }
.btn-danger { background-color: #dc3545; }
.btn-secondary { background-color: #6c757d; }
.details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.card h3 {
    margin-top: 0;
    color: var(--primary-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}
.card p { margin: 10px 0; }
.badge {
    background-color: var(--secondary-color);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.9em;
}
.full-width {
    grid-column: 1 / -1;
}
.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
.styled-table th, .styled-table td {
    padding: 12px;
    border: 1px solid var(--border-color);
}
.styled-table th { background-color: #f8f9fa; }
.btn-danger-small {
    color: #dc3545;
    text-decoration: none;
    font-size: 0.9em;
}
.notifications-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.notifications-card li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
}
.copy-text {
    width: 100%;
    min-height: 80px;
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    resize: vertical;
}
</style>
<script>
document.getElementById('copy-summary')?.addEventListener('click', function() {
    const text = document.getElementById('summary-text');
    if (text) {
        navigator.clipboard.writeText(text.value);
    }
});
</script>
{% endblock %}